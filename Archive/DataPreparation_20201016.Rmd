---
title: "Untitled"
output: html_document
editor_options: 
  chunk_output_type: console
---

The aim of this document is to prepare the data and outline the available sample size of the LHAMT Project

```{r package, include=FALSE}

rm(list=ls())

library(tidyverse)
library(RMySQL)
library(lubridate)
library(rvg)
library(officer)

```



```{r DB connect, include=FALSE}
#connect to DB, local = 1 if at project or local = 0 if AMS server  
con<-db_connect(username = 'philippev',local=0)

```


## Load Data 

###CSV

```{r CSV}


#Get euthanized animals
LHAMT_Brain <- con %>%
  dbGetQuery ("SELECT * FROM user_philippev.Brain") %>% 
  mutate(SacrificeDate = ymd(SacrificeDate)) %>% 
  filter(BranUse == "RNAseq" | BranUse == "") %>% #L2M008 had empty brain use on brain table 
  mutate(BreedingStatus = case_when(AnimalID == "Z3M006" ~ "Breeder", #Correction as wa labelled as unknown
                                    TRUE ~ BreedingStatus)) %>% 
  distinct()#to remove duplicated of L2M008
View(LHAMT_Brain)
#We have brain for RNAseq from 79 individuals
#This include animals that should actually be dismissed from the dataset, at which point should they be discarded?


#get punches
LHAMT_Punched <- read.csv("Punches_SampleID_20200323.csv") %>% 
  mutate(AnimalID = as.character(AnimalID)) %>%
   mutate(AnimalID = case_when(AnimalID == "N0F009" ~ "NOF009",
                              AnimalID == "N0M003" ~ "NOM003",
                              AnimalID == "N0F007" ~ "NOF007",
                              AnimalID == "N0M004" ~ "NOM004",
                              AnimalID == "T1F003" ~ "TIF003",
                              AnimalID == "T1F005" ~ "TIF005",
                              AnimalID == "T1F008" ~ "TIF008",
                              TRUE ~ AnimalID))


#Get sequenced punches
LHAMT_Sequenced <- read.csv("LHAMT_SamplesSequenced.csv") %>% 
  rename(PunchID = SampleID) %>% 
  mutate(AnimalID = as.character(AnimalID)) %>% 
  mutate(AnimalID = case_when(AnimalID == "N0F009" ~ "NOF009",
                              AnimalID == "N0M003" ~ "NOM003",
                              AnimalID == "N0F007" ~ "NOF007",
                              AnimalID == "N0M004" ~ "NOM004",
                              AnimalID == "T1F003" ~ "TIF003",
                              AnimalID == "T1F005" ~ "TIF005",
                              AnimalID == "T1F008" ~ "TIF008",
                              TRUE ~ AnimalID))#a few animals names were changed in the file received from Hans
View(LHAMT_Sequenced)

```

###Individual Info

Run the Data_Import&Prep R file 


###Behaviour
```  {r Scan}

#Get Scan Session Old import 
Scan_SessionDetails_Old <- 
   con %>%
  dbGetQuery ("SELECT ScanRef,
tblColonyCodes.Colony,
DATE(StartDate) AS ObsDate,
TotalScanNumber
FROM Moleratdatabase.tblScanSessionDetails
LEFT JOIN Moleratdatabase.tblColonyCodes ON Moleratdatabase.tblScanSessionDetails.ColonyRef = tblColonyCodes.ColonyRef") %>% 
  mutate(ObsDate = ymd(ObsDate))
View(Scan_SessionDetails_Old)

#Get Scan Behaviour Instantaneous Old
#To get all Scan Ref the animals were part of
Scan_InstBehav_Old <- con %>%
  dbGetQuery ("SELECT * FROM Moleratdatabase.tblScanBehaviour") %>% 
  distinct(ScanRef,AnimalID)
View(Scan_InstBehav_Old)


#All individual scan dates old import
IndividualScanDate_Old_All <- Scan_InstBehav_Old %>% 
  left_join(.,Scan_SessionDetails_Old %>% select(ScanRef,ObsDate)) %>% 
  distinct(AnimalID,ObsDate)#I could also get group from here

View(IndividualScanDate_Old_All)


#Get Scan Session New import 
Scan_SessionDetails_New <- con %>%
  dbGetQuery ("SELECT * FROM MR_RawData.qryScanFileSession") %>% 
  rename(ObsDate = ObservationDate) %>% 
  mutate(ObsDate = ymd(ObsDate)) %>% 
  rename(ScanRef = ScanFileID)
View(Scan_SessionDetails_New)

#Get Scan Behaviour Instantaneous New
#Don't rerun this code it takes forever
#I cannot get colony from here, I would have to reun membership()
Scan_InstBehav_New <- con %>%
  dbGetQuery ("SELECT * FROM MR_RawData.qryScanInstantaneous") %>% 
  distinct(Subject,ScanFileID) 

Scan_InstBehav_New_II <- Scan_InstBehav_New %>% 
  rename(AnimalID = Subject, ScanRef = ScanFileID)
View(Scan_InstBehav_New_II)


#All individual scan dates New import
IndividualScanDate_New_All <- Scan_InstBehav_New_II %>% 
  left_join(.,Scan_SessionDetails_New %>% select(ScanRef,ObsDate)) %>% 
  distinct(AnimalID,ObsDate)
View(IndividualScanDate_New_All)


#Get all dates of scan observation (Old and new import)
#It really would be best to have the group. Thus modify the codes above
IndividualScanDate_OldNew_All <- bind_rows(IndividualScanDate_Old_All ,IndividualScanDate_New_All)
View(IndividualScanDate_OldNew_All)

```

```{r Focal}

```


##Data Preparation

The LHAMT project is made of some (not all) experimental subjects originating from the LHAM experiment and non-experimental individuals. I first generate general info for all animals that were part of the LHAMT, then information specific to the LHAM animals (not all of which were euthanized for LHAMT), then bind the general and LHAM specific infor for animals that were part of LHAMT


###General Animal Info

We start by querying general information relevant to both LHAM subjects and non-experimental individuals euthanized within the frame of the LHAMT

```{r LHAM-LHAMT AnimalID info}

#LHAM Subjects
LHAM_SubjectID <- Experiments_SubjectID %>% 
  filter(ExpName =="LHAM") %>% 
  distinct() %>% #to remove duplicationn of BEM021
  filter(!(AnimalID %in% c("GMM001","CAM002","G10F026","G3M020","VIF018")))#G3M020 was paired with G10F024 originally from Seregenti to form Addo, G10F026 was paired with G3M014 originally from Serengeti to form Who
View(LHAM_SubjectID)


#Euthanized non-experimental individual
LHAMT_NonExp_AnimalID <- LHAMT_Brain %>% 
  distinct(AnimalID) %>% 
  anti_join(.,LHAM_SubjectID) %>% 
  mutate(ExpName = NA)
View(LHAMT_NonExp_AnimalID)
#27 non-experimental animals among the 79 euthanized animals of LHAM Tissue


#LHAMT
LHAMT_AnimalID <- LHAMT_Brain %>% 
  distinct(AnimalID) %>% 
  mutate(LHAMT_Euthanized = "Yes")
View(LHAMT_AnimalID)
#79 euthanized animals
  

#LHAM and LHAMT non-experimental subjects 
LHAM_LHAMT_AnimalID <- bind_rows(LHAM_SubjectID,LHAMT_NonExp_AnimalID) %>% 
  left_join(.,LHAMT_AnimalID) %>% 
  mutate(LHAMT_Euthanized = replace_na(LHAMT_Euthanized, "No"))
View(LHAM_LHAMT_AnimalID)#
#102 individuals


#get individual characteristics
LHAM_LHAMT_AnimalInfo <- idinfo_static(LHAM_LHAMT_AnimalID %>% 
                                         select(AnimalID)) %>% 
  left_join(.,LHAM_LHAMT_AnimalID) %>% 
  relocate(ExpName:LHAMT_Euthanized,.after=AnimalID) %>% 
  left_join(.,Litter_Info %>% 
              filter(IndividualConceptionCount_Total == 1) %>% 
              select(AnimalID,PairingColony,ConceptionDate,ConceptionColony,ParturitionDate,ParturitionColony) %>% 
              rename(FirstLitter_PairingColony = PairingColony,
                     FirstLitter_ConceptionDate = ConceptionDate ,
                     FirstLitter_ConceptionColony = ConceptionColony,
                     FirstLitter_ParturitionDate = ParturitionDate,
                     FirstLitter_ParturitionColony = ParturitionColony))
View(LHAM_LHAMT_AnimalInfo)

```


###LHAM info 

Information that are specific to animals that were part of the LHAM experiments

The code has been taken from NPAC/HormoneAnalyses/NPAC/PreExtraction/HormoneAnalyses_SampleSelection/SampleSelection_BreedingOpportunity. Instead of running the code, I could also just use a csv. 

```{r General Info}

#General info on LHAM animals
LHAM_SubjectID_Info <- LHAM_LHAMT_AnimalInfo %>% 
  filter(ExpName == "LHAM")

#get Experimental group by querying GroupMembership 2 week after experiment start
#Could be an issue if animal died within 2 weeks of animal start
LHAM_ExperimentalColony <- membership(LHAM_SubjectID %>% 
  mutate(Date = ExperimentStartDate + 14) %>% #I put 14 cause Dave had a few experiment start wrong
  select(AnimalID,Date), MembershipBetweenV2) %>% 
  select(-ColonyLocation) %>% 
  rename(ExperimentalGroup = Colony)
View(LHAM_ExperimentalColony)
#Date must be kept or else treatment cannot be queried


#get the group size one week after experiment start 
# this will be useful to assign treatment (solitary animals)
LHAM_ColonySize <- groupcomp(LHAM_ExperimentalColony %>% 
                                select(ExperimentalGroup,Date) %>% 
                                rename(Colony = ExperimentalGroup), MembershipBetweenV2) %>% 
  #GROUP BY COLONY, DATE
  group_by(Colony,Date) %>% 
  mutate(GroupSize_W1 = n()) %>% #also returns a row for 
  ungroup() %>% 
  #UNGROUP
  rename(ExperimentalGroup = Colony)
View(LHAM_ColonySize)


#Get Colony in which animal started the experiment
LHAM_StartColony <- membership(LHAM_SubjectID_Info %>%
                                  select(AnimalID,BirthDate) %>% 
                                   rename(Date = BirthDate) %>% 
                                   mutate(Date = Date + 20),#this is to avoid CF animals returning the colony of birth
                                 MembershipBetweenV2) %>% 
  select(AnimalID,Colony) %>% 
  rename(StartGroup = Colony)
View(LHAM_StartColony)


#Query Treatment
#Based on whether animal changed group or not AND the size of the new group they were part of (group size of 1 in case of solitary)
LHAM_SubjectID_Treatment <- LHAM_SubjectID %>%
  left_join(.,LHAM_StartColony) %>%
  left_join(.,LHAM_ExperimentalColony %>% select(-Date)) %>% 
  inner_join(.,LHAM_ColonySize %>% 
                mutate(Date = Date-14) %>% 
                select(-ExperimentalGroup), by=c("AnimalID" = "AnimalID", "ExperimentStartDate" = "Date")) %>% 
   mutate(Treatment = case_when(GroupSize_W1 == 1 ~ "Solitary",
                                GroupSize_W1 != 1 & ExperimentalGroup != StartGroup ~ "Breeder", #Exclude CF helper that like breeder have changed groups
                                 TRUE ~ "Helper")) %>% #add Treatment
  select(AnimalID,Treatment)
View(LHAM_SubjectID_Treatment)


#generate an Experimental Unit
#I do not know how to do that in one go in a pipe, cur_group_id() indexes without starting at 0 for when changing groups
#ask Colin
LHAM_ExperimentalUnit <- LHAM_SubjectID_Treatment %>%
  left_join(.,LHAM_SubjectID) %>% 
  left_join(.,LHAM_SubjectID_Info %>% 
              select(AnimalID,Sex,LitterRef)) %>% 
  arrange(ExpName,Sex,ExperimentStartDate) %>% #to have the experimentalunit referring the sequence in which animals were done
  distinct(ExpName,Sex,ExpName,LitterRef) %>%
  #GROUP BY EXPNAME, SEX
  group_by(ExpName,Sex) %>% 
  mutate(ExperimentalUnit = row_number()) %>% #this generates an ExperimentUnit, I would not know how to do that without a distinct that reduces to one row per litter. 
  ungroup() %>% 
  #UNGROUP()
  select(ExpName,Sex,LitterRef,ExperimentalUnit)
View(LHAM_ExperimentalUnit)


###########################################Combine all information
LHAM_Info <- LHAM_SubjectID %>%
  left_join(.,LHAM_SubjectID_Info %>% 
              select(AnimalID,Sex,LitterRef,BirthDate,DeathDate)) %>% 
  left_join(.,LHAM_StartColony) %>% 
  left_join(.,LHAM_ExperimentalColony) %>%
  left_join(.,LHAM_ExperimentalUnit) %>%
  left_join(.,LHAM_SubjectID_Treatment) %>% 
  mutate(ExperimentalSeries = case_when(ExpName == "LHAM" & ExperimentStartDate > "2017-10-01"  ~ 2, 
                                        TRUE ~ 1)) %>% #add an experimental serie for LHAM as it may explain difference in sampling
  mutate(ExperimentStartAge = (ExperimentStartDate - BirthDate)/30.4375) %>% #age at which animal started the experiment
  mutate(Experiment_Duration = (DeathDate - ExperimentStartDate)/ 30.4375) %>% 
  #mutate(Experiment_Duration = as.double(difftime(DeathDate,ExperimentStart,units = "weeks"))) %>% 
  arrange(ExpName,Sex,ExperimentStartDate) %>% 
  select(-Date)
View(LHAM_Info)
#75 entries 

```


Pairing and Parturition data. Unsure yet they will be useful here 
```{r Pairing and Parturition}

#get the pairing date and group associated with experiment
#animals may have been paired 2x
#Not all of these pairing led to conception
LHAM_Pairing <- LHAM_Info %>% 
  left_join(.,tblPairing %>% 
              rename(PairingColony = Colony)) %>%
  #GROUP BY AnimalID
  group_by(AnimalID) %>% 
  mutate(IndividualPairing_NB = row_number(),
         NextPairingDate = lead(PairingDate)) %>% 
  ungroup() %>% 
  #UNGROUP
  mutate(PairingExperimentStart_DayDiff = PairingDate - ExperimentStartDate) %>% 
  filter(Treatment == "Breeder") %>%  # note that one control animal paired from Lorenz was paired to form virgin Island
  select(AnimalID,IndividualPairing_NB,PairingDate,NextPairingDate)
View(LHAM_Pairing)
#41 rows


#LHAM subjects paired more than once
LHAM_RepeatedPairing <- LHAM_Pairing %>%
  filter(IndividualPairing_NB > 1)  
View(LHAM_RepeatedPairing)
#Some animals were paired more than once within frame of experiments


#litter produced as a result of each pairing LHAMBS pairing
#Keep in min dthat all pairing did not produced a litter (death of partner)
LHAM_ParturitionDate <- LHAM_Info %>% 
  filter(Treatment == "Breeder") %>% #to avoid getting litters produced by animal from helper treatment later in their life
  left_join(LHAM_Pairing) %>% 
  select(AnimalID,Sex,ExpName,ExperimentalUnit,PairingDate,NextPairingDate) %>% 
  left_join(Litter_Info %>% 
              select(AnimalID, PairingDate, PairingColony, IndividualConceptionCount_Total,ParturitionDate,ParturitionColony)) %>% #add litters produced by the pairing
  mutate(ParturitionPairing_DayDiff = ParturitionDate - PairingDate)
View(LHAM_ParturitionDate)
#NA indicate that the pairing did not lead to a parturition (which doesn't mean that the animal may not have conceived, but this info will remain unknown)


View(LHAM_ParturitionDate %>% 
       group_by(AnimalID) %>% 
       mutate(ParturitionColonyCount = n_distinct(ParturitionColony)) %>% 
       ungroup() %>% 
       filter(ParturitionColonyCount>1))
#DAM002 produced litters in Okavango and Gombe; pairing in Gombe missing from tblPairing posted in Gitlab


#Get First parturition of a pairing
#Pay attention it is not the first pairing ever but only tell us whether a pairing has been succesful
LHAM_Pairing_FirstParturitionDate <- LHAM_ParturitionDate %>% 
  #GROUP BY AnimalID
  group_by(AnimalID,PairingDate) %>% 
  filter(ParturitionPairing_DayDiff == min(ParturitionPairing_DayDiff) | is.na(ParturitionPairing_DayDiff)) %>% 
  ungroup() %>% 
  #UNGROUP 
  mutate(SuccesfullPairing = case_when(is.na(ParturitionDate) ~ "No",
                                       TRUE ~ "Yes") ) %>% 
  select(AnimalID,PairingDate,SuccesfullPairing) %>% 
  distinct() 
View(LHAM_Pairing_FirstParturitionDate)


#Get First parturition date ever for each individual
LHAM_FirstParturitionDate <- LHAM_ParturitionDate %>% 
  filter(IndividualConceptionCount_Total == 1) %>% 
  select(AnimalID,ParturitionDate) %>% 
  rename(FirstParturitionDate = ParturitionDate)
View(LHAMBS_FirstParturitionDate)
  

View(anti_join(LHAM_Pairing,LHAM_Pairing_FirstParturitionDate,by=c("AnimalID","PairingDate")))
#No mismatch LHAMBS Pairing and parturion when left join on AnimalID and paring date
```


```{r All Info}
LHAM_Info_ForSelection <- LHAM_Info %>% 
  left_join(.,LHAM_Pairing) %>% 
  left_join(.,LHAM_Pairing_FirstParturitionDate) %>% 
  left_join(.,LHAM_FirstParturitionDate)
View(LHAM_Info_ForSelection)
#83 entries  
```


###LHAMT and LHAM info

```{r LHAM-LHAMT individual info}

LHAMT_AnimalInfo_All <- LHAMT_AnimalID %>%
  left_join(.,LHAM_LHAMT_AnimalInfo) %>% 
  left_join(.,LHAM_Info) %>% 
  left_join(.,LHAMT_Brain %>% select(AnimalID,Training,BreedingStatus)) %>% 
  left_join(.,LHAMT_Punched %>% 
              distinct(AnimalID) %>% 
              mutate(Punched = "Yes")) %>% 
  left_join(.,LHAMT_Sequenced %>% 
              distinct(AnimalID) %>% 
              mutate(Sequenced = "Yes")) %>% 
  mutate(DevelopingColony = case_when(AnimalID %in% c("L2F010","L2F009") ~ "Lonely 2",
                                      AnimalID == "Z3F022" ~ "Z3T003",
                                      TRUE ~ DevelopingColony)) %>% 
  mutate(BreedingStatus = case_when(DeathAge < 100 ~ "Pup",
                                    TRUE ~ BreedingStatus)) %>% #to change the breedingStatus of the 4 pups to pups to generate correct samples size
  mutate(Queried_BreedingStatus = case_when(!(is.na(FirstLitter_ConceptionDate)) ~ "Breeder",
                                              AnimalID == "Z3F022" ~ "Solitary", # non-experimental animal that was solitary
                                              BreedingStatus == "King"|BreedingStatus =="Queen" ~ "Breeder",
                                              TRUE ~ BreedingStatus)) %>% 
  relocate(StartGroup:Experiment_Duration,.after = ExperimentStartDate) %>% 
  arrange(Sex,DevelopingColony,LitterRef,Treatment)
View(LHAMT_AnimalInfo_All)


#Duration of experiment of animals part of LHAMT
summary(as.numeric(LHAMT_AnimalInfo_All$Experiment_Duration))
#the maximum duration of the experiment was 25 months 


#Min age at which an animal started the experiment
summary(as.numeric(LHAMT_AnimalInfo_All$ExperimentStartAge))
#the maximum duration of the experiment was 13.5 months 
```


##Sample size and data check

79 animals were euthanized (females: 20 non-breeders, 8 solitary, 13 breeders; males:16 non-breeders, 18 breeders, 4 pups), including 52 subjects which were part of an experiment in which the breeding status of same-sex litter mate was experimentally controlled. In 19 cases, euthanization was not a priori planned in the generation of the data set but for health reasons and or training purposes. 


ARF013 (Helper from Aristotle): taken out for blood and found to be paralyzed from hips down
Not sequenced

BEF001 (Helper from Bennett): had a calcified growth on lower right jaw. Had been monitored for a month before was decided to euthanize. Have a look at weight profile to assess whether could be used or not.
Has been sequenced

G4F022 (Helper from G4): Was an experimental LHAM animal but was found in Curie, I believe on the morning it was supposed to be sacrificed. One would need to assess for how long the animal had been left in Curie
Not sequenced

G13M006 (Breeder from G13): euthanized for health reasons. According to the vet due to a liver disease causing water retention in abdomen
Not sequenced

Z3M006 (Breeder from Z3): Was hit by a pipe during cleaning. Dead or near dead by the time it was euthanized
Not sequenced

Z3M025 (Helper from Z3): found sick with diarhea at 11 a.m. put in box and euthanized at 1 p.m. Animal almost if not dead by the time of euthanasia. 
Not sequenced

Z4M001 (Breeder from Bshary): Animal found dying (as good as dead) in colony. Head taken for brain sampling. Necropsy done by IG: discolored kidney, small pancreas, dark gall bladder, white spots on spleen, thinning of wall of intestine, large intestine yellowish
Not sequenced


Micropunches were collected from the brain of 54 individuals (females: 15 non-breeders, 8 solitary, 11 breeders; males:10 non-breeders, 10 breeders). One entire euthanized experimental unit (CUM002, CUM003) and two partial experimental unit were not punched. Among the animals from whom micropunches were collected, 

i) 4 brains were meant to be used for training purposes (L2F009 and L2F010 from L2T002, Z3F022 from Z3T003, and BEF001 from Bennett). 

ii) 3 brains were assigned to breeders that had never produced a litter. LAF007 and TSM038 from Bontebok and RAM001 from Karoo (the female was not euthanized)


All individuals from which micropunches were collected had at least one sample being sequenced. Analyses should be re-run after the exclusion of samples that were collected for training purposes (see above). Z3F022 should be considered as a solitary female (has been changed in the code above) and whether LAF007 and TSM038 (Bontebok), and RAM001 who were all labelled as breeders had conceived should be verified. 

Micropunches that were sequenced should be highlighted on the pictures of brain slices to assess whether exclusion from the dataset or better alternatives should be considered. 

```{r Punches-Sequencing data check}

########################################Euthanized animals

#Sample size
table(LHAMT_AnimalInfo_All$Sex, LHAMT_AnimalInfo_All$Queried_BreedingStatus)
#20 NB females
#8 Solitary female
#13 Breeding female 

#16 NB males
#18 B males (Z3m006 classified as unknown but is a breeder)
#4 pups


#Euthanized animals that are experimental
View(LHAMT_AnimalInfo_All %>%
       filter(ExpName == "LHAM"))


#Helpers that bred?
View(LHAMT_AnimalInfo_All %>% 
       filter(BreedingStatus == "Helper") %>% 
       filter(!(is.na(FirstLitter_ConceptionDate))))
#No helper that were assigned the status of helper ever gave birth
  

#Breeders that never bred?
View(LHAMT_AnimalInfo_All %>% 
       filter(BreedingStatus %in% c("King","Queen")) %>% 
       filter(is.na(FirstLitter_ConceptionDate)))
#Bontebok pair (LAF007, TSM038) never gave birth in the lab but I would need to check with Rachel that the queen was pregnant at the time of sacrifice
#RAM001 the king from Karoo may never have conceived. He had been paired with ARF001 on 30th October 2017 who died on the 30th March 2018. ARF014 was then added into Karoo on the 19 September 2018 and RAM001 euthanized 8 days later on the 27th September 2018. 
#We should have a look at whether ARF001 and ARF014 ever gave evidence of pregnancy. If not the male could be excluded from analyses



########################################Punches
#Sample size of punched animals
Punched_Subset <- LHAMT_AnimalInfo_All %>% 
  filter(Punched == "Yes")
View(Punched_Subset)
#54 distinct animals out of the 79 individuals that were euthanized were punched

#Sample size
table(Punched_Subset$Sex, Punched_Subset$Queried_BreedingStatus)


#sample zie of punched experimental animal
Punched_Experimental <- Punched_Subset %>% 
  filter(ExpName == "LHAM")
table(Punched_Experimental$Sex, Punched_Experimental$Queried_BreedingStatus)


#Table of experimental animals 
Female_Dataset_Table <- Punched_Subset %>% 
  filter(Sex == "F") %>% 
  select(AnimalID, Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus) %>%
  #GROUP BY 
  group_by(Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus) %>% 
  summarise(Count = n()) %>% 
  ungroup() %>% 
  #UNGROUP 
  pivot_wider(names_from = Queried_BreedingStatus, values_from = Count) %>% 
  rename(StartColony = DevelopingColony) %>% 
  arrange(Sex,StartColony, ExperimentalUnit) %>% 
  replace_na(list(Breeder = 0, Helper = 0, Solitary = 0, ExperimentalUnit = "Non-Experimental"))
View(Female_Dataset_Table)

write.csv(Female_Dataset_Table,"Female_Dataset_Table.csv",row.names = FALSE)


Male_Dataset_Table <- Punched_Subset %>% 
  filter(Sex == "M") %>% 
  select(AnimalID, Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus) %>%
  #GROUP BY 
  group_by(Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus) %>% 
  summarise(Count = n()) %>% 
  ungroup() %>% 
  #UNGROUP 
  pivot_wider(names_from = Queried_BreedingStatus, values_from = Count) %>% 
  rename(StartColony = DevelopingColony) %>% 
  arrange(Sex,StartColony, ExperimentalUnit) %>% 
  replace_na(list(Breeder = 0, Helper = 0, Solitary = 0, ExperimentalUnit = "Non-Experimental"))
View(Male_Dataset_Table)

write.csv(Male_Dataset_Table,"Male_Dataset_Table.csv",row.names = FALSE)


#Euthanized animals not punched
LHAMT_NotPunched <- LHAMT_AnimalInfo_All %>% 
  filter(is.na(Punched)) %>% 
  arrange(AnimalID)
View(LHAMT_NotPunched)
#25 animals were not punched

#6 animals for which euthanization was not planned: G13M006 (breeder G13), Z3M006 (Breeder Z3), Z3M025 (helper Z3), Z4M001 (breeder Bshary), G4F022 (LHAM control found in Curie), ARF013 (euthanized animal due to paralyzation)

#4x pups for Shazia: VIF018, ENM014, MEM026, TSM053 done for shazia

#2x Breeding Females
 #L2F020 LHAM Amboseli
 #HEF001 LHAM Virunga (Control HEF003 had become breeder in Hermes)

#3x Non-breeding females
 # G4F019 LHAM  
 #G1F022 LHAM 
 #ARF002 LHAM 

#5x Breeding males
 #CUM002 LHAM Amboseli
 #CRM003 LHAM Virunga
 #Z1M022 LHAM Aloatra
 #LOM002 LHAM Kilimanjaro
 #LOM008 Non-experimental Masai Mara

#5x Non-breeding males
 #CUM003 LHAM Helper (euthanized for Shazia, why wasn't it euthanized at same time than    CUM002? possibly because alone in its tunnel system CUT001)
 #GLM003 Shazia 12M
 #L6M014 Shazia 12M
 #LYM003 Shazia Old
 #SAM002 Shazia Old


#Experimentals animals that were not punched
LHAMT_ExperimentalNotPunched <- LHAMT_AnimalInfo_All %>% 
  filter(LHAMT_Euthanized == "Yes") %>% 
  filter(!(is.na(ExperimentalUnit))) %>% 
  filter(is.na(Punched)) %>% 
  select(Sex, ExperimentalUnit, BreedingStatus,AnimalID)
View(LHAMT_ExperimentalNotPunched)
#10 experimentals animals were among the 25 non-punched animals
#All of them were single representative of their Experiment Unit at the exception of Experimental Unit Male 4 (CUM002, Amoboseli; CUM003, Curie)


#Experimental units in which not all animals were punched 
LHAM_IncompletePunch <- LHAMT_AnimalInfo_All %>% 
              filter(Punched == "Yes") %>%
              filter(!(is.na(ExperimentalUnit))) %>% 
              select(Sex,ExperimentUnit,AnimalID,BreedingStatus) %>% #get all experiment animals that were punched
  inner_join(., LHAMT_AnimalInfo_All %>% #join to same Sex and Experiment Unit that were not punched
  filter(is.na(Punched)) %>% 
  select(Sex, ExperimentalUnit, BreedingStatus,AnimalID),by=c("Sex","ExperimentUnit"))
View(LHAM_IncompletePunch)
#There are 2 experimental animals that were not punched and should ideally have since a representant of their experimental unit was punched. The 2 experimental units were only constituted of a solitary and a helper but not by a breeder
#G1F022 LHAM helper, G1F025 is a solitary that had been punched
#G4F019 LHAM helper (had emigrated into Tesla on the 6th Dec 2017 the day was supposed to be euthanized, was euthanized the day after), G4F020 is a solitary that had been punched
  

#Experimental and non-experimental animals from same StartColony that were not entirely punched
LHAMT_IncompletePunch <- LHAMT_AnimalInfo_All %>% 
  filter(Punched == "Yes") %>%
  filter(!(Training == "Yes")) %>% 
  select(Sex,FirstColony,AnimalID,BreedingStatus) %>% #get all non-training animals that were punched
  inner_join(., LHAMT_AnimalInfo_All %>% #join to same Sex and StartColony that were not punched
  filter(is.na(Punched)) %>% 
  select(Sex, FirstColony, ExperimentUnit,BreedingStatus,AnimalID),by=c("Sex","FirstColony"))
View(LHAMT_IncompletePunch)
#it looks like that none of the unpunched animals were of the same group as the punched animals, beside the 2 experimental animals mentionned above



#################################################Sequencing

Sequenced_Subset <- LHAMT_AnimalInfo_All %>% 
  filter(Sequenced == "Yes")
View(Sequenced_Subset)
#54 distinct animals were sequenced
#Thus seems all punched animals were sequenced

#Data check: Animals sequenced but not punched
View(anti_join(LHAMT_AnimalInfo_All %>% 
  filter(Sequenced == "Yes"),LHAMT_AnimalInfo_All %>% 
  filter(Punched == "Yes"),by=("AnimalID")))
#It seemed that CRF007 did not appear on the Punches file. 
#CRF002 had been duplicated. Excel file has been corrected but must be checked on paper sheet


#Join the Info on animals which brain had been punched with sequencing info
SequencingInfo <- Sequenced_Subset %>% 
  left_join(.,LHAMT_Sequenced %>% 
              select(AnimalID, BrainRegion))
View(SequencingInfo)


#Animals that were considered as training animals and that were sequenced
LHAMT_Training_Sequenced <- LHAMT_AnimalInfo_All %>% 
       filter(Sequenced == "Yes") %>%
       filter(Training == "Yes")
View(LHAMT_Training_Sequenced)
#4 animals that were sequenced were considered as training animals 
#L2F009: Was in L2T002 when euthanized
#L2F010: Was in L2T002 when euthanized
#Z3F022: Was in Z3T003 when euthanized
#BEF001:had a calcified growth on lower right jaw. Had been monitored for a month before was decided to euthanize. Have a look at weight profile to assess whether could be used or not.
#Analyses should be considered in their absence


#Group Size of animals that were sequenced and considered as training 
Training_Membership <- membership(LHAMT_Training_Sequenced %>% 
                                  select(AnimalID, DeathDate) %>% 
                                  rename(Date = DeathDate) %>% 
                                  mutate(Date = Date -7),Membership_Extract)
View(Training_Membership)

Training_GroupSize <- groupcomp(Training_Membership %>% 
                                  select(Colony,Date),
                                Membership_Extract)
#Z3F022 should be considered as a solitary female
#L2F009 and F010 were living together 


#Table of female experimental and non-experimental animals 
Female_Dataset_Table <- Punched_Subset %>% 
  filter(Sex == "F") %>% 
  select(AnimalID, Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus) %>%
  #GROUP BY 
  group_by(Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus) %>% 
  summarise(Count = n()) %>% 
  ungroup() %>% 
  #UNGROUP 
  pivot_wider(names_from = Queried_BreedingStatus, values_from = Count) %>% 
  rename(StartColony = DevelopingColony) %>% 
  arrange(Sex,StartColony, ExperimentalUnit) %>% 
  replace_na(list(Breeder = 0, Helper = 0, Solitary = 0, ExperimentalUnit = "Non-Experimental"))
View(Female_Dataset_Table)


#Table of male experimental and non-experimental animals 
Male_Dataset_Table <- Punched_Subset %>% 
  filter(Sex == "M") %>% 
  select(AnimalID, Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus) %>%
  #GROUP BY 
  group_by(Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus) %>% 
  summarise(Count = n()) %>% 
  ungroup() %>% 
  #UNGROUP 
  pivot_wider(names_from = Queried_BreedingStatus, values_from = Count) %>% 
  rename(StartColony = DevelopingColony) %>% 
  arrange(Sex,StartColony, ExperimentalUnit) %>% 
  replace_na(list(Breeder = 0, Helper = 0, Solitary = 0, ExperimentalUnit = "Non-Experimental"))
View(Male_Dataset_Table)


#Brain region sequenced by animal ID for female 
Female_Brainregion_Table <- SequencingInfo %>% 
  filter(Sex == "F") %>% 
  select(AnimalID, Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus, BrainRegion) %>%
  #GROUP BY 
  group_by(AnimalID,Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus,BrainRegion) %>% 
  summarise(Count = n()) %>% 
  ungroup() %>% 
  #UNGROUP 
  pivot_wider(names_from = BrainRegion, values_from = Count) %>% 
  rename(StartColony = DevelopingColony) %>% 
  arrange(StartColony, ExperimentalUnit) %>% 
  replace_na(list(AMY = 0, CA1 = 0, CA3 = 0, mPA = 0, ExperimentalUnit = "Non-Experimental" ))
View(Female_Brainregion_Table)


#Brain region sequenced by animal ID for male 
Male_Brainregion_Table <- SequencingInfo %>% 
  filter(Sex == "M") %>% 
  select(AnimalID, Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus, BrainRegion) %>%
  #GROUP BY 
  group_by(AnimalID,Sex, DevelopingColony, ExperimentalUnit, Queried_BreedingStatus,BrainRegion) %>% 
  summarise(Count = n()) %>% 
  ungroup() %>% 
  #UNGROUP 
  pivot_wider(names_from = BrainRegion, values_from = Count) %>% 
  rename(StartColony = DevelopingColony) %>% 
  arrange(Sex,StartColony, ExperimentalUnit) %>% 
  replace_na(list(AMY = 0, CA1 = 0, CA3 = 0, mPA = 0, ExperimentalUnit = "Non-Experimental" ))
View(Male_Brainregion_Table)


#sample size of brain regions by Breeding status 
Sequenced_Brainregion_Dataset_Table <- SequencingInfo %>% 
  select(Sex, Queried_BreedingStatus, BrainRegion) %>%
  #GROUP BY 
  group_by(Sex,BrainRegion, Queried_BreedingStatus) %>% 
  summarise(Count = n()) %>% 
  ungroup() %>% 
  #UNGROUP 
  pivot_wider(names_from = Queried_BreedingStatus, values_from = Count) %>%
  replace_na(list(Solitary = 0))
View(Sequenced_Brainregion_Dataset_Table)

write.csv(Sequenced_Brainregion_Dataset_Table,"Sequenced_Brainregion_Dataset_Table.csv",row.names = FALSE)



##############################################Sample size for mPOA

mPOA_Subset <- SequencingInfo %>% 
  filter(BrainRegion == "mPA")
View(mPOA_Subset)

table(Punched_Experimental$Sex, Punched_Experimental$Queried_BreedingStatus)


###############################################Sample size for CA1

###############################################Sample size for CA3 

###############################################Sample size for Amy

```


```{r Time period}

#Duration of experiment of animals part of LHAMT for which some of the brain region were sequenced
summary(as.numeric(Sequenced_Subset$Experiment_Duration))
#the maximum duration of the experiment was 23.63 months 
#the mean duration of experiment was 16.40 months
#the median duration of experiment was 18.76


#Min age at which an animal started the experiment
summary(as.numeric(Sequenced_Subset$ExperimentStartAge))
#the younger subject who started the experiment was 13.63 months 

View(Sequenced_Subset)

###############################################Determination of time period during which animals where available

#Time period during which animals were available
TimePeriod <- LHAMT_AnimalInfo_Sequenced %>% 
  mutate(ExperimentStartDate = case_when(is.na(ExperimentStartDate) ~ DeathDate - 500,
                                         TRUE ~ ExperimentStartDate)) %>% #assign a fake experiment date to non experimental animals coresponding to 16.4 montsh (average experiment time)
  mutate(Experiment_Duration = case_when(is.na(Experiment_Duration) ~ (DeathDate - ExperimentStartDate)/30.4375,
                                         TRUE ~ Experiment_Duration)) %>% 
  select(AnimalID,BirthDate,ExperimentStartDate,DeathDate,Experiment_Duration) %>%
  mutate(OneYear_BDay = BirthDate %m+% period("12 month")) %>% 
  mutate(Three_M = DeathDate %m-% period("3 month"),
         Six_M = DeathDate %m-% period("6 month"),
         Nine_M = DeathDate %m-% period("9 month"),
         Twelve_M = DeathDate %m-% period("12 month"),
         Fifteen_M = DeathDate %m-% period("15 month"),
         Eighteen_M = DeathDate %m-% period("18 month"),
         TwentyOne_M = DeathDate %m-% period("21 month"),
         TwentyFour_M = DeathDate %m-% period("24 month")) %>% 
  pivot_longer(Three_M:TwentyFour_M,names_to = "Period", values_to = "PeriodDate" ) %>% 
  mutate(PeriodAge = (PeriodDate - BirthDate)/30.4375) %>% 
  arrange(AnimalID)
View(TimePeriod)
names(TimePeriod)


#^ months time period during which animals were alive and older than 12months after the experiment start 
#This does not include start date for animals which may have less than 
AnimalID_TimePeriod_AfterFirst <- TimePeriod %>% 
  filter(Period %in% c("Six_M", "Twelve_M","Eighteen_M","TwentyFour_M")) %>% 
  #GROUP BY AnimalID
  group_by(AnimalID) %>% 
  arrange(desc(PeriodDate)) %>% 
  mutate(NextPeriod = lead(Period)) %>% 
  ungroup() %>% 
  #UNGROUP
  filter((PeriodAge > 12 |is.na(BirthDate)) & PeriodDate > (ExperimentStartDate) | Experiment_Duration < 6 & Period == "Six_M") %>% 
  mutate(PeriodDate = case_when(PeriodDate < ExperimentStartDate ~ ExperimentStartDate,
                                TRUE ~ PeriodDate))
  
View(AnimalID_TimePeriod_AfterFirst)


#First available time period
AnimalID_TimePeriod_First<- AnimalID_TimePeriod_AfterFirst  %>%
  #GROUP BY 
  group_by(AnimalID) %>% 
  slice_min(PeriodDate) %>% #get the first time period
  ungroup() %>% 
  #UNGROUP
  select(AnimalID,NextPeriod) %>% 
  rename(Period = NextPeriod) %>% 
  left_join(.,TimePeriod) %>% 
  filter(Experiment_Duration > 6) %>% #to avoid getting the 12 months period if the experiment lasted less than 6 months  
  mutate(PeriodDate = case_when(OneYear_BDay > ExperimentStartDate ~ OneYear_BDay,
                                OneYear_BDay < ExperimentStartDate |is.na(BirthDate) ~ ExperimentStartDate))
View(AnimalID_TimePeriod_First)
#52 individuals 
# there is a loss of 2 animals in comparison to the 54 euthanized animals. I need to have a look why


anti_join(Sequenced_Subset %>% 
            select(AnimalID),AnimalID_TimePeriod_First)


#Bind row of first period after experiment start with other time period until death
AvailablePeriod<- bind_rows(AnimalID_TimePeriod_AfterFirst,AnimalID_TimePeriod_First) %>% 
  select(AnimalID,Period,PeriodDate) %>% 
  bind_rows(.,LHAMT_AnimalInfo_All %>% 
              select(AnimalID,DeathDate) %>% 
              rename(PeriodDate = DeathDate) %>% 
              mutate(Period = "Death")) %>% 
  arrange(AnimalID,desc(PeriodDate)) %>% 
  group_by(AnimalID) %>% 
  mutate(EndPeriod = lead(Period),
           EndPeriodDate = lead(PeriodDate)) %>% 
  filter(!(is.na(EndPeriod)))
View(AvailablePeriod)
  

#PeriodList
PeriodList <- AvailablePeriod %>% 
  distinct(AnimalID,EndPeriod) %>% 
  rename(Period = EndPeriod)
View(PeriodList)

```



##Scan 


## Urine and Plasma samples
The maximum duration of the experiment was 25 months 

```{r data prep}

#################################################Urine

LHAMT_Urine <- AvailablePeriod %>% 
  left_join(.,PlasmaUrine %>% 
              filter(SampleType =="Urine",
                     SampleRepeat == 1)) %>% 
  filter(CollectionDate < PeriodDate & CollectionDate > EndPeriodDate) %>% 
  left_join(.,LHAMT_AnimalInfo_All %>% 
              select(AnimalID,Sex,Queried_BreedingStatus))
View(LHAMT_Urine)


LHAMT_Urine_PeriodCount <- LHAMT_Urine %>% 
group_by(AnimalID,EndPeriod) %>% 
  summarize(SampleCount = n()) %>% 
  ungroup()
View(LHAMT_Urine_PeriodCount)
  
names(LHAMT_AnimalInfo_All)


```


```{r}




```






```{r data exploration and summary}

#ExperimentDuration
View(LHAMT_Sequenced_IDinfo %>% 
       arrange(Experiment_Duration))
summary(as.numeric(LHAMT_Sequenced_IDinfo$Experiment_Duration))
#Experimental animals that were euthanized were paired for at least 10 months at the only exception of TSM038 (Bontebok King) and M039 (control) that were euthanized one month after being used 

table(LHAMT_Sequenced_IDinfo$Sex,LHAMT_Sequenced_IDinfo$BreedingStatus)


#Age of youngest sequenced animal at the start of experiment 
#This could inform when we could start taking behavioural data before pairing
summary(as.numeric(LHAMT_Sequenced_IDinfo$ExperimentStart_Age))
View(LHAMT_Sequenced_IDinfo %>% 
  filter(ExperimentStart_Age < 15))
#G1F025 Kruger solitary was the youngest animal to enter the experiment was 13.6 months
#4 animals were younger than 15 months at the start of experiment


#Are thre any non-experimental breeder (to assess if all breeders had an experimental start)
#That will be an issue to assess how many scans done after they have been paired (since there is no experimental start)
View(LHAMT_Sequenced_IDinfo %>% 
  filter(BreedingStatus == "King" & is.na(ExperimentStart) | BreedingStatus == "Queen" & is.na(ExperimentStart)))
#G3M020 king from Addo
#G10F026 queen from Who
#This will cause an issue when querying the behaviours

View(LHAMT_Sequenced_IDinfo)


#Euthanized animals not punched 
#Animals were either not punched because they were of no use OR because of lack of time
Euthanized_NotPunched<- anti_join(LHAMT_IDinfo,Punches_AnimalList,by="AnimalID") %>% 
  arrange(Sex,AnimalID,Training)
View(Euthanized_NotPunched)
#26 animals euthanized but not punched

#6 animals for which euthanization was not planned: G13M006 (breeder G13), Z3M006 (Breeder Z3), Z3M025 (helper Z3), Z4M001 (breeder Bshary), G4F022 (LHAM control found in Curie), ARF013 (euthanized animal due to paralyzation)

#4 pups for Shazia: VIF018, ENM014, MEM026, TSM053 done for shazia
#2 12m for Shazia: #GLM005, L6M014 
#3 Old for Shazia: LYM003, SAM002, CUM003


##11 animals remain: I must write a reason for the consequence of these animal not being done. I was trying prioritize animals for wich another animal from the same unit was present so perhaps that explains

#L2F020 LHAM queen from Amboseli
#CUM002 LHAM King Amboseli

#HEF001 LHAM queen from Virunga
#CRM003 LHAM King Virunga

#CRF007 LHAM queen from Masai Mara 
#LOM008 Breeder in Masai Mara non-experimental

#Z1M022 LHAM King Aloatra

#LOM002 LHAM King in Kilimanjaro

#TSM038 LHAM King Bontebok apparently punched


#G4F019 LHAM Helper 
#G1F022 LHAM Helper
#ARF002 LHAM Helper


#Animals punched but not sequenced
#Are there animals that had been forgotten for sequencing?
#Are there animals that were punched and perhaps should not have been sequenced


#Similar Brain region sequenced 2x
Duplicated_BrainRegion <- Sequencing %>% 
  group_by(AnimalID,BrainRegion) %>% 
  mutate(BrainRegion_Duplicate = n()) %>% 
  ungroup() %>% 
  filter(BrainRegion_Duplicate >1)
# GRF004 AMY
# WAF011 CA1 
# Why?


#Overview of brain region sequenced by individuals
BrainRegion_ByIndividual <- Sequencing %>%  
  select(AnimalID,Sex,BreedingStatus,BrainRegion) %>% 
  group_by(AnimalID,BrainRegion) %>% 
  mutate(Count = n()) %>% 
  ungroup() %>% 
  distinct() %>% 
  pivot_wider(names_from = BrainRegion, values_from = Count) %>% 
  arrange(Sex,BreedingStatus,AnimalID)
View(BrainRegion_ByIndividual)
#A few individuals have not had all of their 3 regions sampled 

```


```{r Behavioural Data}

#Scan observation performed on sequenced animals 
#Must have Group, ObsDate, AnimalID 
Sequenced_Scan <- Sequencing_AnimalList %>% 
  left_join(.,IndividualScanDate_OldNew_All) %>% 
  left_join(.,LHAMT_Sequenced_IDinfo)
View(Sequenced_Scan)
#1325 scans were collected on animals that were sequenced


#Add age of animals at each scan 
#Add the delay with death
#Was it before or after Experiment start? There are two breeders that are non-experimental G3M020 king from Addo and G10F026 queen from Who. I will manually add the pairing date as "ExperimentStart" for plotting purpose
poop <- LHAMT_Sequenced_IDinfo %>% 
  select(AnimalID,BreedingStatus,BirthDate,DeathDate,ExperimentStart) %>% 
  mutate(ExperimentStart = as.character(ExperimentStart)) %>% 
  mutate(ExperimentStart = case_when (AnimalID == "G3M020" ~ "2017-06-18",
                                      AnimalID == "G10F026" ~ "2017-06-18",
                                      TRUE ~ ExperimentStart)) %>% #assign a fake start date to non-experimental breeder in dataset
  mutate(ExperimentStart = ymd(ExperimentStart)) %>% 
  left_join(Sequenced_Scan) %>% 
  mutate(ObsAge = as.numeric(ObsDate - BirthDate)/30.4375) %>% #Age in months at which animal were observed
  mutate(Obs_DeathDelay = as.numeric(DeathDate - ObsDate)/30.4375) %>% 
  mutate(Obs_ExpStartDelay = as.numeric(ObsDate - ExperimentStart)/30.4375) %>% 
        mutate(MonthsBeforeDeath = case_when(Obs_DeathDelay < 6 ~ 6,
                                            Obs_DeathDelay >= 6 & Obs_DeathDelay <12  ~ 12,
                                           Obs_DeathDelay >= 12 & Obs_DeathDelay <18  ~ 18,
                                           Obs_DeathDelay >= 18 & Obs_DeathDelay <24  ~ 24,
                                           Obs_DeathDelay >= 24 & Obs_DeathDelay <30  ~ 30,
                                           Obs_DeathDelay >= 30 & Obs_DeathDelay <36  ~ 36,
                                           Obs_DeathDelay >= 36 & Obs_DeathDelay <42.5  ~ 42,
                                          TRUE ~ Obs_DeathDelay))
View(poop)
#1325 scan


poop2 <- poop %>% 
  filter (
    (BreedingStatus == "Solitary" & Obs_ExpStartDelay > 0) |
            (BreedingStatus == "Queen" & Obs_ExpStartDelay > 0) |
             (BreedingStatus == "King" & Obs_ExpStartDelay > 0) |
              (ObsAge > 11 & is.na(Obs_ExpStartDelay))| #non experimental helpers
             (ObsAge > 11 & BreedingStatus == "Helper" & !(is.na(Obs_ExpStartDelay)))
    ) %>% #Experimental helpers
  mutate(MonthsBeforeDeath = as.factor(MonthsBeforeDeath))
str(poop2)


poop3 <- poop2 %>% 
  select(AnimalID, BreedingStatus,MonthsBeforeDeath) %>% 
  group_by(AnimalID, BreedingStatus, MonthsBeforeDeath) %>% 
  summarize(Scan_Count = n()) %>% 
  arrange(BreedingStatus,AnimalID,MonthsBeforeDeath) 
str(poop3)
#this reduces to 555 scans


#probably better to do them as 4 separate plot and to join them after
figure_Scan<- ggplot(poop3, aes(MonthsBeforeDeath,Scan_Count)) +
  geom_boxplot(outlier.shape = NA,) +
  geom_jitter(width=0.3, size=3, alpha = 0.25)+
    facet_grid(rows = vars(BreedingStatus))+
  theme_bw() 




my_pres<-
  # Load template
  read_pptx() %>%
  # 02 - SLIDE
  add_slide(layout = "Title and Content", master = "Office Theme") %>%
  # 02 - Title
  ph_with_text(type = "title", str = "") %>%
  ph_with_vg(code = print(figure_Scan)) %>% 
  print(.,target="Scan.pptx")
    
  

```

```{r urine data}

Sequenced_Urine <- Sequencing_AnimalList %>% 
  left_join(.,Urine_Collected %>% 
              select(AnimalID,UrineNumber,UrineDate))
View(Sequenced_Urine)
#1626 collected on the euthanized animals



#Add age of animals at each scan 
#Add the delay with death
#Was it before or after Experiment start? There are two breeders that are non-experimental G3M020 king from Addo and G10F026 queen from Who. I will manually add the pairing date as "ExperimentStart" for plotting purpose
Urine <- LHAMT_Sequenced_IDinfo %>% 
  select(AnimalID,BreedingStatus,BirthDate,DeathDate,ExperimentStart) %>% 
  mutate(ExperimentStart = as.character(ExperimentStart)) %>% 
  mutate(ExperimentStart = case_when (AnimalID == "G3M020" ~ "2017-06-18",
                                      AnimalID == "G10F026" ~ "2017-06-18",
                                      TRUE ~ ExperimentStart)) %>% #assign a fake start date to non-experimental breeder in dataset
  mutate(ExperimentStart = ymd(ExperimentStart)) %>% 
  left_join(Sequenced_Urine) %>% 
  mutate(UrineAge = as.numeric(UrineDate - BirthDate)/30.4375) %>% #Age in months at which Urine was collected
  mutate(Urine_DeathDelay = as.numeric(DeathDate - UrineDate)/30.4375) %>% 
  mutate(Urine_ExpStartDelay = as.numeric(UrineDate - ExperimentStart)/30.4375) %>% 
        mutate(MonthsBeforeDeath = case_when(Urine_DeathDelay < 6 ~ 6,
                                            Urine_DeathDelay >= 6 & Urine_DeathDelay <12  ~ 12,
                                           Urine_DeathDelay >= 12 & Urine_DeathDelay <18  ~ 18,
                                           Urine_DeathDelay >= 18 & Urine_DeathDelay <24  ~ 24,
                                           Urine_DeathDelay >= 24 & Urine_DeathDelay <30  ~ 30,
                                           Urine_DeathDelay >= 30 & Urine_DeathDelay <36  ~ 36,
                                           Urine_DeathDelay >= 36 & Urine_DeathDelay <42.5  ~ 42,
                                          TRUE ~ Urine_DeathDelay))
View(Urine)
#1626 scan

Urine2 <- Urine %>% 
  filter (
    (BreedingStatus == "Solitary" & Urine_ExpStartDelay > 0) |
            (BreedingStatus == "Queen" & Urine_ExpStartDelay > 0) |
             (BreedingStatus == "King" & Urine_ExpStartDelay > 0) |
              (UrineAge > 11 & is.na(Urine_ExpStartDelay))| #non experimental helpers
             (UrineAge > 11 & BreedingStatus == "Helper" & !(is.na(Urine_ExpStartDelay)))
    ) %>% #Experimental helpers
  mutate(MonthsBeforeDeath = as.factor(MonthsBeforeDeath))
View(Urine2)
#569 urine samples


Urine3 <- Urine2 %>% 
  select(AnimalID, BreedingStatus,MonthsBeforeDeath) %>% 
  group_by(AnimalID, BreedingStatus, MonthsBeforeDeath) %>% 
  summarize(Urine_Count = n()) %>% 
  arrange(BreedingStatus,AnimalID,MonthsBeforeDeath) 
View(Urine3)
#this reduces to


#probably better to do them as 4 separate plot and to join them after
figure_Urine<- ggplot(Urine3, aes(MonthsBeforeDeath,Urine_Count)) +
  geom_boxplot(outlier.shape = NA,) +
  geom_jitter(width=0.3, size=3, alpha = 0.25)+
    facet_grid(rows = vars(BreedingStatus))+
  theme_bw() 


my_pres<-
  # Load template
  read_pptx() %>%
  # 02 - SLIDE
  add_slide(layout = "Title and Content", master = "Office Theme") %>%
  # 02 - Title
  ph_with_text(type = "title", str = "") %>%
  ph_with_vg(code = print(figure_Urine)) %>% 
  print(.,target="Urine.pptx")



```

